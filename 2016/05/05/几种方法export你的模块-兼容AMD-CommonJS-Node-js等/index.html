<!DOCTYPE html><html lang="zh-cmn-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 几种方法export你的模块(兼容AMD, CommonJS, Node.js等) · Ken's Blog － 黄凯羿的个人博客，分享javascript,前端开发,设计和生活。</title><meta name="description" content="几种方法export你的模块(兼容AMD, CommonJS, Node.js等) - Ken Huang"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="http://fonts.useso.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">博客</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">分类</a></li><li class="nav-list-item"><a href="http://weibo.com/witnesswithyou" target="_blank" class="nav-list-link">微博</a></li><li class="nav-list-item"><a href="https://github.com/kenhky" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="http://www.huangkaiyi.com" target="_blank" class="nav-list-link">主页</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">几种方法export你的模块(兼容AMD, CommonJS, Node.js等)</h1><div class="post-time">May 5, 2016</div><div class="post-content"><p>模块化是前端这几年提的比较多的技术点，前端代码不像后端代码，Javascript不是一种模块化编程语言，直到es6才开始支持class和module。为了让大家能方便的加载各种模块，出现了一些Javascript的模板规范，如 CommonJS 和 AMD 。</p>
<p>我们一般遇到一些通用的可以模块出来的代码，可以根据我们所用的规范来export你的代码。但是想要多种规范和没有规范直接使用都支持呢？像jquery等框架一样的通用代码该怎么做呢？</p>
<p>通过查看jQuery的源码，可以整理出如下：</p>
<pre><code><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"> global, factory </span>) </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> ( <span class="keyword">typeof</span> <span class="built_in">module</span> === <span class="string">"object"</span> &amp;&amp; <span class="keyword">typeof</span> <span class="built_in">module</span>.exports === <span class="string">"object"</span> ) &#123;</div><div class="line">        <span class="comment">// For CommonJS and CommonJS-like environments where a proper `window`</span></div><div class="line">        <span class="comment">// is present, execute the factory and get jQuery.</span></div><div class="line">        <span class="comment">// For environments that do not have a `window` with a `document`</span></div><div class="line">        <span class="comment">// (such as Node.js), expose a factory as module.exports.</span></div><div class="line">        <span class="comment">// This accentuates the need for the creation of a real `window`.</span></div><div class="line">        <span class="comment">// e.g. var jQuery = require("jquery")(window);</span></div><div class="line">        <span class="comment">// See ticket #14549 for more info.</span></div><div class="line">        <span class="built_in">module</span>.exports = global.document ?</div><div class="line">            factory( global, <span class="literal">true</span> ) :</div><div class="line">            <span class="function"><span class="keyword">function</span>(<span class="params"> w </span>) </span>&#123;</div><div class="line">                <span class="keyword">if</span> ( !w.document ) &#123;</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>( <span class="string">"jQuery requires a window with a document"</span> );</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">return</span> factory( w );</div><div class="line">            &#125;;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        factory( global );</div><div class="line">    &#125;</div><div class="line"></div><div class="line"><span class="comment">// Pass this if window is not defined yet</span></div><div class="line">&#125;(<span class="keyword">typeof</span> <span class="built_in">window</span> !== <span class="string">"undefined"</span> ? <span class="built_in">window</span> : <span class="keyword">this</span>, <span class="function"><span class="keyword">function</span>(<span class="params"> window, noGlobal </span>) </span>&#123;</div><div class="line">  <span class="comment">// jQuery code</span></div><div class="line">&#125;));</div></pre></td></tr></table></figure>
</code></pre><p>可以看到 typeof window !== “undefined” ? window : this 用于判断当前执行环境是否支持window类型，是的话返回window，否则返回this。如果当前环境不支持window.document属性，throw一个Error说这环境不适用jQuery，但依旧返回jQuery的功能函数。实际上我们想模块化的代码很多时候不像jQuery一样大而全并且依赖window.document属性，有没有更好的写法呢？</p>
<p>有一个很流行的时间处理函数库叫moment.js，它兼容我们想要的多种方式，让我们看下它是怎么实现的：</p>
<pre><code><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">;(<span class="function"><span class="keyword">function</span> (<span class="params">global, factory</span>) </span>&#123;</div><div class="line">    <span class="keyword">typeof</span> exports === <span class="string">'object'</span> &amp;&amp; <span class="keyword">typeof</span> <span class="built_in">module</span> !== <span class="string">'undefined'</span> ? <span class="built_in">module</span>.exports = factory() :</div><div class="line">    <span class="keyword">typeof</span> define === <span class="string">'function'</span> &amp;&amp; define.amd ? define(factory) :</div><div class="line">    global.moment = factory()</div><div class="line">&#125;(<span class="keyword">this</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; <span class="string">'use strict'</span>;</div><div class="line">    <span class="comment">//return moment</span></div><div class="line">&#125;)</div></pre></td></tr></table></figure>
</code></pre><p>和jQuery很像嘛，这样看起来就简单多了，就是判断一下是否支持commonJs，然后判断是否支持AMD，否则直接挂在global上。</p>
<p>其实写法不止一种，但是原理都是大同小异。再分享一下cookie.js的写法：</p>
<pre><code><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">(<span class="function"><span class="keyword">function</span> (<span class="params">undefined</span>) </span>&#123;</div><div class="line"><span class="meta">    'use strict'</span>;</div><div class="line"></div><div class="line">    <span class="keyword">var</span> Cookies = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="comment">//cookie code</span></div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="comment">// cookie code</span></div><div class="line">    Cookies._document = <span class="built_in">document</span>;</div><div class="line"></div><div class="line">        <span class="comment">// AMD support</span></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> define === <span class="string">'function'</span> &amp;&amp; define.amd) &#123;</div><div class="line">        define(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; <span class="keyword">return</span> Cookies; &#125;);</div><div class="line">    <span class="comment">// CommonJS and Node.js module support.</span></div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> exports !== <span class="string">'undefined'</span>) &#123;</div><div class="line">        <span class="comment">// Support Node.js specific `module.exports` (which can be a function)</span></div><div class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="built_in">module</span> !== <span class="string">'undefined'</span> &amp;&amp; <span class="built_in">module</span>.exports) &#123;</div><div class="line">            exports = <span class="built_in">module</span>.exports = Cookies;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// But always support CommonJS module 1.1.1 spec (`exports` cannot be a function)</span></div><div class="line">        exports.Cookies = Cookies;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="built_in">window</span>.Cookies = Cookies;</div><div class="line">    &#125;</div><div class="line">&#125;)();</div></pre></td></tr></table></figure>
</code></pre></div></article></div></section><footer><div class="paginator"><a href="/2016/07/24/一个简单的react native menu button组件/" class="prev">PREV</a><a href="/2016/04/26/javascript判断两个多边形相交/" class="next">NEXT</a></div><div data-thread-key="2016/05/05/几种方法export你的模块-兼容AMD-CommonJS-Node-js等/" data-title="几种方法export你的模块(兼容AMD, CommonJS, Node.js等)" data-url="http://www.huangkaiyi.me/2016/05/05/几种方法export你的模块-兼容AMD-CommonJS-Node-js等/" data-author-key="1" class="ds-thread"></div><script>var duoshuoQuery = {short_name:"kenhky"};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
})();

</script><div class="copyright"><p>© 2016 <a href="http://www.huangkaiyi.me">Ken Huang</a> 粤ICP备15066407号 邮箱:ken.hky@163.com</p></div></footer></div><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>