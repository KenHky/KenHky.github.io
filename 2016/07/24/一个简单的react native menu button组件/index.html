<!DOCTYPE html><html lang="zh-cmn-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 一个简单的react native menu button组件 · Ken's Blog － 黄凯羿的个人博客，分享javascript,前端开发,设计和生活。</title><meta name="description" content="一个简单的react native menu button组件 - Ken Huang"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="http://fonts.useso.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">博客</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">分类</a></li><li class="nav-list-item"><a href="http://weibo.com/witnesswithyou" target="_blank" class="nav-list-link">微博</a></li><li class="nav-list-item"><a href="https://github.com/kenhky" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="http://www.huangkaiyi.com" target="_blank" class="nav-list-link">主页</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">一个简单的react native menu button组件</h1><div class="post-time">Jul 24, 2016</div><div class="post-content"><p>最近我司有一个内部轻app由我们前端开发，技术选型不假思索的选择了react-native。谁叫react-native这么火呢。如今此app已经开始使用了，开发过程中有一个又一个的坑,下次专门写篇博文聊一聊踩坑。</p>
<p>我们有一个需求是在title的右边有一个button，点击弹出一个menu。网上搜一下有人实现了这样的组件（这里推荐一个寻找react-native或者react组件的网站：<a href="https://js.coach/" target="_blank" rel="external">js.coach</a>），叫<a href="https://github.com/jaysoo/react-native-menu" target="_blank" rel="external">react-native-menu</a>。试用了一下，功能是可以了，但是打开menu后想点击别的地方关闭menu比较麻烦，要调用自身的方法。深入它的代码想看看是怎么实现的，经过断点发现它只要打开menu就有一个方法每隔16毫秒setState一次，一直循环。这对性能有很大的影响。</p>
<p>仔细想一下，其实实现这样一个功能并不难，干脆自己造轮子好了。首先要想的是怎么才能方便的点击外部方便的关闭menu。这种需要弹出的东西而且只会弹出一个的完全可以用原生的modal实现。我把这个组件分为一个个小组件拼接成这个menu button。</p>
<p>先写了一个按钮命名为MenuSwitch，接收两个props，一个是点击事件onPress，一个是按钮里的样式content，默认content我写成这样 :</p>
<pre><code><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;Text style=&#123;&#123; fontSize: 20,textAlign:"right" &#125;&#125;&gt;&amp;#8942;&lt;/Text&gt;</div></pre></td></tr></table></figure>
</code></pre><p>点击这个button会改变一个state的值用来控制显示或不显示menu。menu写在一个modal里面，modal独立为一个组件叫MenuModal，点击的时候控制关闭modal。modal上面有一个menu独立为MenuOptions组件，点击的时候相应相应的事件。这时好奇的宝宝可能会问了，react-native是不是像web一样有一个冒泡捕获的过程。实际上react-native的onPress事件如果有多层次的话只会执行嵌套最深的那次，不会冒泡到外面的onPress事件的。所以我们点击menu的时候不会调用modal上的onPress方法。</p>
<p>Menu显示的条数由组件外部传入一个menuGroup控制，格式为：[{key:num or str,value:num or str,text:str,hide:Boolean}]。value为点击发生后传的值，text为显示的字符串，hide为true时隐藏该条数据，默认为false。</p>
<p>写到这里我们的menu组件就差不多完成了，处理下细节，组件内的render如下：</p>
<pre><code><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">render () &#123;</div><div class="line">    <span class="keyword">const</span> &#123;openMenu,menuName,layout&#125; = <span class="keyword">this</span>.state</div><div class="line">    <span class="keyword">const</span> &#123;buttonStyle,menuGroup,optionsStyle,button&#125; = <span class="keyword">this</span>.props</div><div class="line">    <span class="keyword">const</span> <span class="built_in">window</span> = Dimensions.get(<span class="string">'window'</span>)</div><div class="line">    <span class="keyword">const</span> optionsStyles = &#123;...optionsStyle,<span class="attr">top</span>:layout.y,<span class="attr">right</span>:(<span class="built_in">window</span>.width-layout.x-layout.width)&#125;</div><div class="line">    <span class="keyword">const</span> buttonContent = button?button:(&lt;Text style=&#123;&#123; fontSize: 20,textAlign:"right" &#125;&#125;&gt;&amp;#8942;&lt;/Text&gt;)</div><div class="line">    <span class="keyword">return</span> (</div><div class="line">        &lt;View style=&#123;buttonStyle&#125; onLayout=&#123;this.onLayout&#125;&gt;</div><div class="line">            &lt;MenuSwitch content=&#123;buttonContent&#125; onPress=&#123;this.toggleMenu&#125;&gt;&lt;/MenuSwitch&gt;</div><div class="line">            &#123;</div><div class="line">                openMenu==menuName?(</div><div class="line">                    &lt;MenuModal onPress=&#123;this.closeMenu&#125;&gt;</div><div class="line">                            &lt;MenuOptions style=&#123;optionsStyles&#125;&gt;</div><div class="line">                                &#123;</div><div class="line">                                    menuGroup.map((menu)=&gt; &#123;</div><div class="line">                                        if (!menu.hide) &#123;</div><div class="line">                                            return (</div><div class="line">                                                &lt;MenuOption key=&#123;menu.key&#125; onPress=&#123;this.onPress.bind(null,menu.value)&#125;&gt;</div><div class="line">                                                    &lt;Text&gt;&#123;menu.text&#125;&lt;/Text&gt;</div><div class="line">                                                &lt;/MenuOption&gt;</div><div class="line">                                            )</div><div class="line">                                        &#125;</div><div class="line">                                    &#125;)</div><div class="line">                                &#125;</div><div class="line">                            &lt;/MenuOptions&gt;</div><div class="line">                    &lt;/MenuModal&gt;</div><div class="line">                ):null</div><div class="line">            &#125;</div><div class="line">        &lt;/View&gt;</div><div class="line"></div><div class="line">    )</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</code></pre><p>最后实现的效果如下：</p>
<p><img src="http://7xtb3a.com2.z0.glb.clouddn.com/menubutton-ios.gif" alt=""><br><img src="http://7xtb3a.com2.z0.glb.clouddn.com/menubutton-android.gif" alt=""></p>
<p>完整的代码可以看这里<a href="https://github.com/KenHky/react-native-menu-button" target="_blank" rel="external">https://github.com/KenHky/react-native-menu-button</a>。</p>
<p>组件我们写完了，怎么使用呢？为们新建一个AwesomeProject,像如下使用：</p>
<pre><code><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">'react'</span>;</div><div class="line"><span class="keyword">import</span> &#123;</div><div class="line">  AppRegistry,</div><div class="line">  StyleSheet,</div><div class="line">  Text,</div><div class="line">  View</div><div class="line">&#125; <span class="keyword">from</span> <span class="string">'react-native'</span>;</div><div class="line"></div><div class="line"><span class="keyword">import</span> MenuButton <span class="keyword">from</span> <span class="string">'react-native-menu-button'</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">AwesomeProject</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</div><div class="line">  componentDidMount() &#123;</div><div class="line"></div><div class="line">  &#125;</div><div class="line">  <span class="keyword">constructor</span>(props) &#123;</div><div class="line">    <span class="keyword">super</span>(props);</div><div class="line">    <span class="keyword">this</span>.state = &#123;</div><div class="line">      <span class="attr">selectData</span>:<span class="string">""</span></div><div class="line">    &#125;;</div><div class="line">  &#125;</div><div class="line">  _handleOnSelect (value) &#123;</div><div class="line">    <span class="keyword">this</span>.setState(&#123;<span class="attr">selectData</span>:value&#125;)</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  render() &#123;</div><div class="line">    menuGroup= [&#123;<span class="attr">key</span>:<span class="string">"0"</span>,<span class="attr">value</span>:<span class="string">"menu1"</span>,<span class="attr">text</span>:<span class="string">"menu1"</span>&#125;,&#123;<span class="attr">key</span>:<span class="string">"1"</span>,<span class="attr">value</span>:<span class="string">"menu2"</span>,<span class="attr">text</span>:<span class="string">"menu2"</span>&#125;,&#123;<span class="attr">key</span>:<span class="string">"2"</span>,<span class="attr">value</span>:<span class="string">"菜单3"</span>,<span class="attr">text</span>:<span class="string">"菜单3"</span>&#125;,&#123;<span class="attr">key</span>:<span class="string">"3"</span>,<span class="attr">value</span>:<span class="string">"菜单4"</span>,<span class="attr">text</span>:<span class="string">"菜单4"</span>&#125;]</div><div class="line"></div><div class="line">    <span class="keyword">return</span> (</div><div class="line">      &lt;View&gt;</div><div class="line">        &lt;View style=&#123;styles.top&#125;&gt;</div><div class="line">          &lt;MenuButton  buttonStyle=&#123;[styles.rightButton]&#125; menuGroup=&#123;menuGroup&#125;</div><div class="line">            onSelect=&#123;this._handleOnSelect.bind(this)&#125;/&gt;</div><div class="line">        &lt;/View&gt;</div><div class="line">        &lt;Text style=&#123;styles.text&#125;&gt;&#123;`select $&#123;this.state.selectData&#125;`&#125;&lt;/Text&gt;</div><div class="line">      &lt;/View&gt;</div><div class="line">    );</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">const styles = StyleSheet.create(&#123;</div><div class="line">  top:&#123;</div><div class="line">    backgroundColor: '#FFFFFF',</div><div class="line">    paddingTop: 20,</div><div class="line">    top: 0,</div><div class="line">    height: 64,</div><div class="line">    right: 0,</div><div class="line">    left: 0,</div><div class="line">    borderBottomWidth: 0.5,</div><div class="line">    borderBottomColor: '#828287',</div><div class="line">    position: 'relative',</div><div class="line">  &#125;,</div><div class="line">  text:&#123;</div><div class="line">    marginTop:20,</div><div class="line">  &#125;,</div><div class="line">  rightButton: &#123;</div><div class="line">    width: 100,</div><div class="line">    height: 37,</div><div class="line">    position: 'absolute',</div><div class="line">    bottom: 8,</div><div class="line">    right: 2,</div><div class="line">    padding: 8</div><div class="line">  &#125;,</div><div class="line">&#125;);</div><div class="line"></div><div class="line">AppRegistry.registerComponent('AwesomeProject', () =&gt; AwesomeProject);</div></pre></td></tr></table></figure>
</code></pre><p>这个组件还有很多不足，如果有什么好的意见建议欢迎联系我哦。</p>
</div></article></div></section><footer><div class="paginator"><a href="/2016/07/24/动手写一个react native的date picker组件/" class="prev">PREV</a><a href="/2016/05/05/几种方法export你的模块-兼容AMD-CommonJS-Node-js等/" class="next">NEXT</a></div><div class="copyright"><p>© 2016 - 2017 <a href="http://www.huangkaiyi.me">Ken Huang</a> 粤ICP备15066407号 邮箱:ken.hky@163.com</p></div></footer></div><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>